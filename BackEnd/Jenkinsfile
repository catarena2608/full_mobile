pipeline {
    agent any

    parameters {
        choice(
            name: 'SERVICE_NAME', 
            choices: ['backend-auth', 'backend-notify', 'backend-post', 'backend-recipe', 'backend-user', 'backend-static', 'gateway', 'gatewayadmin'], 
            description: 'Ch·ªçn Microservice c·∫ßn Build v√† Deploy'
        )
    }

    tools {
        nodejs 'nodejs' 
    }
    
    environment {
        DOCKER_REGISTRY = "catarena" 
        KUBE_NAMESPACE = "default" 
        
        // C·∫•u h√¨nh ƒë∆∞·ªùng d·∫´n
        SERVICE_PATH = "BackEnd/${params.SERVICE_NAME}/" 
        
        // üëá THAY ƒê·ªîI: C·ªë ƒë·ªãnh tag l√† :latest ngay t·∫°i ƒë√¢y
        IMAGE_TAGGED = "${DOCKER_REGISTRY}/${params.SERVICE_NAME}:latest"

        // C·∫•u h√¨nh Google Cloud (Gi·ªØ nguy√™n n·∫øu b·∫°n d√πng sau n√†y)
        GCP_PROJECT_ID = "mobile-project-477308"
        GCP_CLUSTER_NAME = "mobile-cluster"
        GCP_ZONE = "asia-southeast1-a"
    }

    stages { 
        stage('Init & Checkout') {
            steps {
                checkout scm
                script {
                    // In ra th√¥ng b√°o ƒë·ªÉ ki·ªÉm tra
                    echo "üì¶ Docker Image will be built as: ${env.IMAGE_TAGGED}"
                }
            }
        }
        
        stage('Run Pipeline') { 
            stages { 
                stage('Scan Dependencies') {
                    steps {
                        script {
                            if (fileExists(env.SERVICE_PATH)) {
                                dir(env.SERVICE_PATH) { 
                                    sh "npm install"
                                    sh "npm audit --audit-level=high || true" 
                                }
                            } else {
                                error "‚ùå Folder not found: ${env.SERVICE_PATH}"
                            }
                        }
                    }
                }
                
                stage('Build & Push Docker') {
                    steps {
                        script {
                            echo "üê≥ Building Docker Image: ${env.IMAGE_TAGGED}"
                            
                            // Build v·ªõi tag latest
                            sh "docker build -t ${env.IMAGE_TAGGED} ./${env.SERVICE_PATH}"
                            
                            withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                                sh 'echo ${PASS} | docker login -u ${USER} --password-stdin'
                                echo "üöÄ Pushing image..."
                                sh "docker push ${env.IMAGE_TAGGED}"
                            }
                        }
                    }
                }
            } 
        } 
    }
    post {
        always {
            script {
                echo "üßπ Cleaning up local Docker images..."
                if (env.IMAGE_TAGGED) {
                    sh "docker rmi ${env.IMAGE_TAGGED} || true"
                }
            }
        }
        success {
            echo "üéâ Pipeline finished successfully!"
        }
        failure {
            echo "üö® Pipeline failed. Please check the logs above."
        }
    }
}