pipeline {
    agent any

    parameters {
        choice(
            name: 'SERVICE_NAME', 
            choices: ['backend-auth', 'backend-notify', 'backend-post', 'backend-recipe', 'backend-user', 'backend-static', 'gateway', 'gatewayadmin'], 
            description: 'Ch·ªçn Microservice c·∫ßn Build v√† Deploy'
        )
    }

    tools {
        nodejs 'nodejs' 
    }
    
    environment {
        DOCKER_REGISTRY = "catarena" 
        KUBE_NAMESPACE = "default" 
        
        // C·∫•u h√¨nh ƒë∆∞·ªùng d·∫´n
        SERVICE_PATH = "BackEnd/${params.SERVICE_NAME}/" 
        
        // Image name
        IMAGE_NAME = "${DOCKER_REGISTRY}/${params.SERVICE_NAME}:latest"
        
        // C·∫•u h√¨nh Google Cloud (N√™n ƒë∆∞a ra bi·∫øn ƒë·ªÉ d·ªÖ s·ª≠a)
        GCP_PROJECT_ID = "mobile-project-477308" // ƒê√£ x√≥a d·∫•u c√°ch th·ª´a
        GCP_CLUSTER_NAME = "mobile-cluster"
        GCP_ZONE = "asia-northeast1"
    }

    stages { 
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Run Pipeline') { 
            stages { 
                stage('Scan Dependencies') {
                    steps {
                        script {
                            if (fileExists(env.SERVICE_PATH)) {
                                dir(env.SERVICE_PATH) { 
                                    sh "npm install"
                                    // B·ªè qua l·ªói audit ƒë·ªÉ pipeline ch·∫°y ti·∫øp (n·∫øu c·∫ßn ch·∫∑n th√¨ b·ªè || true)
                                    sh "npm audit --audit-level=high || true" 
                                }
                            } else {
                                error "‚ùå Folder not found: ${env.SERVICE_PATH}"
                            }
                        }
                    }
                }
                
                stage('Build & Push Docker') {
                    steps {
                        script {
                            echo "üê≥ Building Docker Image..."
                            // Build tag latest
                            sh "docker build -t ${IMAGE_NAME} ./${env.SERVICE_PATH}"
                            
                            withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                                sh 'echo ${PASS} | docker login -u ${USER} --password-stdin'
                                echo "üöÄ Pushing image: ${IMAGE_NAME}"
                                sh "docker push ${IMAGE_NAME}"
                            }
                        }
                    }
                }

                // =========================================================
                // üëá PH·∫¶N DEPLOY K8S ƒê√É T·ªêI ∆ØU (ZERO DOWNTIME)
                // =========================================================
                stage('Deploy to K8s') {
                    agent {
                        docker {
                            image 'catarena/gcloud-agent:latest'
                            // Mount docker socket n·∫øu c·∫ßn d√πng docker trong agent n√†y (tu·ª≥ ch·ªçn)
                            // args '-v /var/run/docker.sock:/var/run/docker.sock' 
                        }
                    }
                    steps {
                        withCredentials([file(credentialsId: 'k8s-mobile-cluster', variable: 'GCP_KEY_FILE')]) {
                            script {
                                echo "=== DEPLOYING: ${params.SERVICE_NAME} ==="
                                
                                // 1. Auth GCP
                                sh 'gcloud auth activate-service-account --key-file=$GCP_KEY_FILE'
                                sh "gcloud container clusters get-credentials ${env.GCP_CLUSTER_NAME} --zone ${env.GCP_ZONE} --project ${env.GCP_PROJECT_ID}"
                                
                                // ƒê·ªãnh nghƒ©a bi·∫øn
                                def yamlFile = "BackEnd/k8s-deployment/${params.SERVICE_NAME}.yaml"
                                // L∆∞u √Ω: T√™n Deployment trong file YAML ph·∫£i ƒë√∫ng format n√†y
                                def deploymentName = "${params.SERVICE_NAME}-deployment"

                                if (fileExists(yamlFile)) {
                                    try {
                                        // 2. APPLY (Update c·∫•u h√¨nh n·∫øu c√≥ thay ƒë·ªïi trong file YAML)
                                        // Kh√¥ng d√πng Delete ƒë·ªÉ tr√°nh downtime
                                        echo "üìÑ Applying configuration..."
                                        sh "kubectl apply -f ${yamlFile} --namespace ${env.KUBE_NAMESPACE}"
                                        
                                        // 3. FORCE RESTART (Quan tr·ªçng khi d√πng tag :latest)
                                        // L·ªánh n√†y √©p K8s pull l·∫°i image m·ªõi nh·∫•t v√† thay th·∫ø d·∫ßn c√°c Pod c≈©
                                        echo "üîÑ Rolling Restart to update image..."
                                        sh "kubectl rollout restart deployment/${deploymentName} --namespace ${env.KUBE_NAMESPACE}"
                                        
                                        // 4. VERIFY
                                        echo "‚è≥ Waiting for rollout to finish..."
                                        sh "kubectl rollout status deployment/${deploymentName} --namespace ${env.KUBE_NAMESPACE} --timeout=2m"
                                        
                                        echo "‚úÖ Deploy SUCCESS!"

                                    } catch (e) {
                                        echo "‚ùå Deployment FAILED: ${e.message}"
                                        echo "üí° G·ª£i √Ω: Ki·ªÉm tra xem t√™n Deployment trong file YAML c√≥ kh·ªõp v·ªõi '${deploymentName}' kh√¥ng?"
                                        currentBuild.result = 'FAILURE'
                                        error("Deploy failed")
                                    }
                                } else {
                                    error "‚ùå YAML File not found at: ${yamlFile}"
                                }
                            }
                        }   
                    }
                }
            } 
        } 
    }
    post {
        always {
            script {
                echo "üßπ Cleaning up local docker images..."
                sh "docker rmi ${env.IMAGE_NAME} || true"
            }
        }
    }
}