pipeline {
    agent any

    parameters {
        choice(
            name: 'SERVICE_NAME', 
            choices: ['backend-auth', 'backend-notify', 'backend-post', 'backend-recipe', 'backend-user', 'backend-static', 'gateway', 'gatewayadmin'], 
            description: 'Ch·ªçn Microservice c·∫ßn Build v√† Deploy'
        )
    }

    tools {
        nodejs 'nodejs' 
    }
    
    environment {
        DOCKER_REGISTRY = "catarena" 
        KUBE_NAMESPACE = "default" 
        
        // C·∫•u h√¨nh ƒë∆∞·ªùng d·∫´n
        SERVICE_PATH = "BackEnd/${params.SERVICE_NAME}/" 
        
        // C·∫•u h√¨nh Google Cloud
        GCP_PROJECT_ID = "mobile-project-477308"
        GCP_CLUSTER_NAME = "mobile-cluster"
        GCP_ZONE = "asia-southeast1-a"
        
        // ‚ùå ƒê√É X√ìA COMMIT_HASH V√Ä IMAGE_TAGGED ·ªû ƒê√ÇY ƒê·ªÇ TR√ÅNH L·ªñI NULL
    }

    stages { 
        stage('Init & Checkout') {
            steps {
                checkout scm
                script {
                    // üëá L·∫•y Commit Hash
                    def shortCommit = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
                    
                    // G√°n v√†o bi·∫øn m√¥i tr∆∞·ªùng env ƒë·ªÉ c√°c stage sau d√πng ƒë∆∞·ª£c
                    env.COMMIT_HASH = shortCommit
                    env.IMAGE_TAGGED = "${DOCKER_REGISTRY}/${params.SERVICE_NAME}:${shortCommit}"
                    
                    echo "üîñ Current Commit Hash: ${env.COMMIT_HASH}"
                    echo "üì¶ Docker Image will be: ${env.IMAGE_TAGGED}"
                    
                    // Ki·ªÉm tra n·∫øu bi·∫øn v·∫´n null th√¨ b√°o l·ªói ngay l·∫≠p t·ª©c
                    if (!env.COMMIT_HASH || env.COMMIT_HASH == "null") {
                        error "‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c Git Commit Hash. Ki·ªÉm tra l·∫°i l·ªánh git."
                    }
                }
            }
        }
        
        stage('Run Pipeline') { 
            stages { 
                stage('Scan Dependencies') {
                    steps {
                        script {
                            if (fileExists(env.SERVICE_PATH)) {
                                dir(env.SERVICE_PATH) { 
                                    sh "npm install"
                                    sh "npm audit --audit-level=high || true" 
                                }
                            } else {
                                error "‚ùå Folder not found: ${env.SERVICE_PATH}"
                            }
                        }
                    }
                }
                
                stage('Build & Push Docker') {
                    steps {
                        script {
                            echo "üê≥ Building Docker Image: ${env.IMAGE_TAGGED}"
                            
                            // Build v·ªõi tag l√† Commit Hash
                            sh "docker build -t ${env.IMAGE_TAGGED} ./${env.SERVICE_PATH}"
                            
                            withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                                sh 'echo ${PASS} | docker login -u ${USER} --password-stdin'
                                echo "üöÄ Pushing image..."
                                sh "docker push ${env.IMAGE_TAGGED}"
                            }
                        }
                    }
                }
            } 
        } 
    }
    post {
        always {
            script {
                echo "üßπ Cleaning up local Docker images..."
                if (env.IMAGE_TAGGED) {
                    sh "docker rmi ${env.IMAGE_TAGGED} || true"
                }
            }
        }
        success {
            echo "üéâ Pipeline finished successfully!"
        }
        failure {
            echo "üö® Pipeline failed. Please check the logs above."
        }
    }
}