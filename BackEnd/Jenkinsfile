pipeline {
    agent any

    parameters {
        choice(
            name: 'SERVICE_NAME', 
            choices: ['backend-auth', 'backend-notify', 'backend-post', 'backend-recipe', 'backend-user', 'backend-static', 'gateway', 'gatewayadmin'], 
            description: 'Ch·ªçn Microservice c·∫ßn Build v√† Deploy'
        )
    }

    tools {
        nodejs 'nodejs' 
    }
    
    environment {
        DOCKER_REGISTRY = "catarena" 
        KUBE_NAMESPACE = "default" 
        
        // C·∫•u h√¨nh ƒë∆∞·ªùng d·∫´n
        SERVICE_PATH = "BackEnd/${params.SERVICE_NAME}/" 
        
        // C·∫•u h√¨nh Google Cloud
        GCP_PROJECT_ID = "mobile-project-477308"
        GCP_CLUSTER_NAME = "mobile-cluster"
        GCP_ZONE = "asia-southeast1-a"
        
        // ‚ùå ƒê√É X√ìA COMMIT_HASH V√Ä IMAGE_TAGGED ·ªû ƒê√ÇY ƒê·ªÇ TR√ÅNH L·ªñI NULL
    }

    stages { 
        stage('Init & Checkout') {
            steps {
                checkout scm
                script {
                    // üëá L·∫•y Commit Hash
                    def shortCommit = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
                    
                    // G√°n v√†o bi·∫øn m√¥i tr∆∞·ªùng env ƒë·ªÉ c√°c stage sau d√πng ƒë∆∞·ª£c
                    env.COMMIT_HASH = shortCommit
                    env.IMAGE_TAGGED = "${DOCKER_REGISTRY}/${params.SERVICE_NAME}:${shortCommit}"
                    
                    echo "üîñ Current Commit Hash: ${env.COMMIT_HASH}"
                    echo "üì¶ Docker Image will be: ${env.IMAGE_TAGGED}"
                    
                    // Ki·ªÉm tra n·∫øu bi·∫øn v·∫´n null th√¨ b√°o l·ªói ngay l·∫≠p t·ª©c
                    if (!env.COMMIT_HASH || env.COMMIT_HASH == "null") {
                        error "‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c Git Commit Hash. Ki·ªÉm tra l·∫°i l·ªánh git."
                    }
                }
            }
        }
        
        stage('Run Pipeline') { 
            stages { 
                stage('Scan Dependencies') {
                    steps {
                        script {
                            if (fileExists(env.SERVICE_PATH)) {
                                dir(env.SERVICE_PATH) { 
                                    sh "npm install"
                                    sh "npm audit --audit-level=high || true" 
                                }
                            } else {
                                error "‚ùå Folder not found: ${env.SERVICE_PATH}"
                            }
                        }
                    }
                }
                
                stage('Build & Push Docker') {
                    steps {
                        script {
                            echo "üê≥ Building Docker Image: ${env.IMAGE_TAGGED}"
                            
                            // Build v·ªõi tag l√† Commit Hash
                            sh "docker build -t ${env.IMAGE_TAGGED} ./${env.SERVICE_PATH}"
                            
                            withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                                sh 'echo ${PASS} | docker login -u ${USER} --password-stdin'
                                echo "üöÄ Pushing image..."
                                sh "docker push ${env.IMAGE_TAGGED}"
                            }
                        }
                    }
                }

                stage('Deploy to K8s') {
                    agent {
                        docker {
                            image 'catarena/gcloud-agent:latest'
                        }
                    }
                    steps {
                        withCredentials([file(credentialsId: 'k8s-mobile-cluster', variable: 'GCP_KEY_FILE')]) {
                            script {
                                echo "=== DEPLOYING VERSION: ${env.COMMIT_HASH} ==="
                                
                                // 1. Auth GCP
                                sh 'gcloud auth activate-service-account --key-file=$GCP_KEY_FILE'
                                sh "gcloud container clusters get-credentials ${env.GCP_CLUSTER_NAME} --zone ${env.GCP_ZONE} --project ${env.GCP_PROJECT_ID}"
                                
                                def yamlFile = "BackEnd/k8s-deployment/${params.SERVICE_NAME}.yaml"
                                def deploymentName = "${params.SERVICE_NAME}"
                                // ‚ö†Ô∏è T√™n Container trong file YAML (th∆∞·ªùng ƒë·∫∑t tr√πng t√™n service)
                                def containerName = "${params.SERVICE_NAME}" 

                                if (fileExists(yamlFile)) {
                                    try {
                                        // 2. APPLY C·∫§U H√åNH
                                        sh "kubectl apply -f ${yamlFile} --namespace ${env.KUBE_NAMESPACE}"
                                        
                                        // 3. SET IMAGE (C·∫≠p nh·∫≠t image m·ªõi)
                                        echo "üîÑ Updating Deployment to use image: ${env.IMAGE_TAGGED}"
                                        sh "kubectl set image deployment/${deploymentName} ${containerName}=${env.IMAGE_TAGGED} --namespace ${env.KUBE_NAMESPACE}"
                                        
                                        // 4. VERIFY
                                        echo "‚è≥ Waiting for rollout..."
                                        sh "kubectl rollout status deployment/${deploymentName} --namespace ${env.KUBE_NAMESPACE} --timeout=2m"
                                        
                                        echo "‚úÖ Deploy SUCCESS! Version: ${env.COMMIT_HASH}"

                                    } catch (e) {
                                        echo "‚ùå Deployment FAILED: ${e.message}"
                                        currentBuild.result = 'FAILURE'
                                        error("Deploy failed")
                                    }
                                } else {
                                    error "‚ùå YAML File not found: ${yamlFile}"
                                }
                            }
                        }   
                    }
                }
            } 
        } 
    }
    post {
        always {
            script {
                echo "üßπ Cleaning up..."
                // Ch·ªâ x√≥a n·∫øu bi·∫øn IMAGE_TAGGED c√≥ gi√° tr·ªã
                if (env.IMAGE_TAGGED) {
                    sh "docker rmi ${env.IMAGE_TAGGED} || true"
                }
            }
        }
    }
}