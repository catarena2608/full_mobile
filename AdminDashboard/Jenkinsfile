pipeline {
    agent any

    tools {
        nodejs 'nodejs' 
    }
    
    environment {
        // C·ªë ƒë·ªãnh t√™n Service cho Pipeline ri√™ng n√†y
        SERVICE_NAME = "webadmin"
        DOCKER_REGISTRY = "catarena" 
        KUBE_NAMESPACE = "default" 
        
        // Th∆∞ m·ª•c ch·ª©a code ngu·ªìn (AdminDashboard)
        SERVICE_PATH = "AdminDashboard"
        
        // C·∫•u h√¨nh Google Cloud
        GCP_PROJECT_ID = "mobile-project-477308"
        GCP_CLUSTER_NAME = "mobile-cluster"
        GCP_ZONE = "asia-southeast1-a"
    }

    stages { 
        stage('Init & Checkout') {
            steps {
                checkout scm
                script {
                    // L·∫•y Commit Hash ƒë·ªÉ l√†m Tag cho Image
                    def shortCommit = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
                    env.COMMIT_HASH = shortCommit
                    env.IMAGE_TAGGED = "${env.DOCKER_REGISTRY}/${env.SERVICE_NAME}:${shortCommit}"
                    
                    echo "üîñ Version Tag: ${env.COMMIT_HASH}"
                    echo "üì¶ Docker Image: ${env.IMAGE_TAGGED}"
                }
            }
        }
        
        stage('Run Pipeline') { 
            stages { 
                stage('Scan & Install Dependencies') {
                    steps {
                        script {
                            dir(env.SERVICE_PATH) { 
                                sh "npm install"
                                sh "npm audit --audit-level=high || true" 
                            }
                        }
                    }
                }
                
                stage('Build & Push Docker') {
                    steps {
                        script {
                            echo "üê≥ Building Docker Image: ${env.IMAGE_TAGGED}"
                            
                            // Build image t·ª´ th∆∞ m·ª•c AdminDashboard
                            sh "docker build -t ${env.IMAGE_TAGGED} ./${env.SERVICE_PATH}"
                            
                            withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                                sh "echo ${PASS} | docker login -u ${USER} --password-stdin"
                                echo "üöÄ Pushing image to Docker Hub..."
                                sh "docker push ${env.IMAGE_TAGGED}"
                            }
                        }
                    }
                }

                stage('Deploy to K8s') {
                    agent {
                        docker {
                            image 'catarena/gcloud-agent:latest'
                        }
                    }
                    steps {
                        withCredentials([file(credentialsId: 'k8s-mobile-cluster', variable: 'GCP_KEY_FILE')]) {
                            script {
                                echo "=== DEPLOYING ${env.SERVICE_NAME} VERSION: ${env.COMMIT_HASH} ==="
                                
                                // 1. Auth GCP & Get Context
                                sh "gcloud auth activate-service-account --key-file=$GCP_KEY_FILE"
                                sh "gcloud container clusters get-credentials ${env.GCP_CLUSTER_NAME} --zone ${env.GCP_ZONE} --project ${env.GCP_PROJECT_ID}"
                                
                                // ƒê∆∞·ªùng d·∫´n file YAML c·ªë ƒë·ªãnh theo service webadmin
                                def yamlFile = "BackEnd/k8s-deployment/${env.SERVICE_NAME}.yaml"
                                
                                if (fileExists(yamlFile)) {
                                    try {
                                        // 2. Apply Resource (Deployment, Service, etc.)
                                        sh "kubectl apply -f ${yamlFile} --namespace ${env.KUBE_NAMESPACE}"
                                        
                                        // 3. Update Image m·ªõi nh·∫•t cho Deployment
                                        // L∆∞u √Ω: deployment name v√† container name trong YAML ph·∫£i l√† 'webadmin'
                                        echo "üîÑ Rolling update image to: ${env.IMAGE_TAGGED}"
                                        sh "kubectl set image deployment/${env.SERVICE_NAME} ${env.SERVICE_NAME}=${env.IMAGE_TAGGED} --namespace ${env.KUBE_NAMESPACE}"
                                        
                                        // 4. Ki·ªÉm tra tr·∫°ng th√°i Rollout
                                        sh "kubectl rollout status deployment/${env.SERVICE_NAME} --namespace ${env.KUBE_NAMESPACE} --timeout=2m"
                                        
                                        echo "‚úÖ DEPLOY SUCCESSFUL"
                                    } catch (e) {
                                        echo "‚ùå Deployment FAILED: ${e.message}"
                                        currentBuild.result = 'FAILURE'
                                        error("Deploy process failed")
                                    }
                                } else {
                                    error "‚ùå YAML File not found at path: ${yamlFile}"
                                }
                            }
                        }   
                    }
                }
            } 
        } 
    }

    post {
        always {
            script {
                echo "üßπ Cleaning up local Docker images..."
                if (env.IMAGE_TAGGED) {
                    sh "docker rmi ${env.IMAGE_TAGGED} || true"
                }
            }
        }
        success {
            echo "üéâ Pipeline finished successfully!"
        }
        failure {
            echo "üö® Pipeline failed. Please check the logs above."
        }
    }
}